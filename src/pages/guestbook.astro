---
export const prerender = false;
import { db, GuestBook, Stamps, desc, sql, eq } from "astro:db";
import BaseLayout from "../layouts/BaseLayout.astro";
import GuestbookEntry from "../components/Guestbook/GuestbookEntry.astro";
import AlertMessage from "../components/Guestbook/AlertMessage.astro";
import Pagination from "../components/Guestbook/Pagination.astro";
import GuestbookForm from "../components/Guestbook/GuestbookForm.astro";
import PageHeader from "../components/PageHeader.astro";
import defaultStampAsset from "../../public/stamps/default.jpg";

const PER_PAGE = 19;

const generateOptimizedCloudinaryUrl = (url: string) => {
  const uploadMarker = "/image/upload/";
  const index = url.indexOf(uploadMarker);
  if (index === -1) return url;
  const baseUrl = url.substring(0, index + uploadMarker.length);
  const imagePath = url.substring(index + uploadMarker.length);
  const transformation = "w_300,h_375,c_fill,f_auto,q_auto:eco,dpr_auto/";
  return `${baseUrl}${transformation}${imagePath}`;
};

if (Astro.request.method === "POST") {
  const contentType = Astro.request.headers.get("content-type");
  if (!contentType || !contentType.includes("multipart/form-data")) {
    return new Response("Invalid content type", { status: 400 });
  }

  const formData = await Astro.request.formData();
  const author = (formData.get("author") as string)?.trim();
  const link = (formData.get("link") as string)?.trim();
  const content = (formData.get("content") as string)?.trim();
  const country = (formData.get("country") as string)?.trim();

  const isValidUrl = (url: string): boolean => {
    try {
      new URL(url);
      return true;
    } catch {
      return false;
    }
  };

  if (!author || !content || !country || content.length > 150) {
    return Astro.redirect("/guestbook?error=invalid_input");
  }
  if (link && !isValidUrl(link)) {
    return Astro.redirect("/guestbook?error=invalid_link");
  }
  if ((content.match(/https?:\/\//g) || []).length > 1) {
    return Astro.redirect("/guestbook?error=too_many_links");
  }

  const insertData: any = {
    author,
    content,
    country,
    timestamp: new Date(),
  };

  if (link) {
    insertData.link = link;
  }

  await db.insert(GuestBook).values(insertData);
  return Astro.redirect("/guestbook?success=message_added");
}

const page = parseInt(Astro.url.searchParams.get("page") || "1");
const offset = (page - 1) * PER_PAGE;

const [guestBook, totalEntriesResult] = await Promise.all([
  db
    .select({
      author: GuestBook.author,
      link: GuestBook.link,
      content: GuestBook.content,
      country: GuestBook.country,
      timestamp: GuestBook.timestamp,
      stampImageUrl: Stamps.imageUrl,
      stampHue: Stamps.hue,
    })
    .from(GuestBook)
    .leftJoin(Stamps, eq(GuestBook.country, Stamps.country))
    .orderBy(desc(GuestBook.timestamp))
    .limit(PER_PAGE)
    .offset(offset),
  db
    .select({ count: sql`count(*)` })
    .from(GuestBook)
]);

const totalEntries = totalEntriesResult[0].count as number;

const success = Astro.url.searchParams.get("success");
const error = Astro.url.searchParams.get("error");
---

<BaseLayout
  title="Guestbook"
  description="A digital guestbook where visitors can leave messages, thoughts, or feedback. Each entry is a snapshot of their visit, complete with a travel stamp from their country."
>
  <main>
    <section class="container">
      <PageHeader
        title="Guestbook"
        description="Leave a message and get a travel stamp!"
      />

      <div class="alert-container">
        {
          success && (
            <AlertMessage
              type="success"
              message="Message added successfully!"
            />
          )
        }
        {
          error === "invalid_input" && (
            <AlertMessage
              type="error"
              message="Invalid input. Ensure author and message are filled."
            />
          )
        }
        {
          error === "invalid_link" && (
            <AlertMessage type="error" message="Invalid URL format." />
          )
        }
        {
          error === "too_many_links" && (
            <AlertMessage type="error" message="Too many links in message." />
          )
        }
      </div>
    </section>

    <section class="guestbook-entries">
      {
        guestBook.map((entry) => {
          const imageAssetForEntry = entry.stampImageUrl
            ? generateOptimizedCloudinaryUrl(entry.stampImageUrl)
            : defaultStampAsset;

          const displayCountry = entry.country || "Unknown";
          const displayHue = entry.stampHue || 210;
          const displayImageAlt = entry.stampImageUrl
            ? `Stamp from ${entry.country} for ${entry.author}'s entry`
            : `Default stamp for ${entry.author}'s entry`;

          return (
            <GuestbookEntry
              name={entry.author}
              link={entry.link}
              message={entry.content}
              date={entry.timestamp}
              country={displayCountry}
              imageUrl={imageAssetForEntry}
              imageAlt={displayImageAlt}
              hue={displayHue}
            />
          );
        })
      }
    </section>

    <Pagination
      currentPage={page}
      hasNextPage={offset + guestBook.length < totalEntries}
      hasPrevPage={page > 1}
    />

    <GuestbookForm />
  </main>

  <button  
    id="scrollToFormBtn"  
    class="floating-btn"
    aria-label="Scroll to guestbook form"
    title="Add your message"
  >
    +
  </button>
</BaseLayout>

<style>
  .alert-container {
    margin-bottom: 24px;
  }

  .guestbook-entries {
    max-width: 120rem;
    margin: 0 auto 48px;
    text-align: center;
  }

  .floating-btn {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 55px;
    height: 55px;
    border-radius: 50%;
    background: var(--tomato-9);
    color: white;
    border: none;
    font-size: 2rem;
    font-weight: 300;
    line-height: 1;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }

  .floating-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  }

  .floating-btn:active {
    transform: scale(0.95);
  }

  @media (max-width: 768px) {
    .floating-btn {
      bottom: 1.5rem;
      right: 1.5rem;
      width: 48px;
      height: 48px;
      font-size: 1.75rem;
    }
  }
</style>

<script>
  function initScrollButton() {
    const scrollBtn = document.getElementById('scrollToFormBtn');
    const form = document.querySelector('form');
    
    if (!scrollBtn || !form) return;
    const newScrollBtn = scrollBtn.cloneNode(true) as HTMLElement;
    scrollBtn.parentNode?.replaceChild(newScrollBtn, scrollBtn);
    
    newScrollBtn.addEventListener('click', () => {
      form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (newScrollBtn) {
          if (entry.isIntersecting) {
            newScrollBtn.style.opacity = '0';
            newScrollBtn.style.pointerEvents = 'none';
          } else {
            newScrollBtn.style.opacity = '1';
            newScrollBtn.style.pointerEvents = 'auto';
          }
        }
      });
    }, {
      threshold: 0.1
    });

    observer.observe(form);
  }

  initScrollButton();

  document.addEventListener('astro:page-load', initScrollButton);
</script>

---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import CenteredLayout from "../../layouts/CenteredLayout.astro";
import PageHeader from "../../components/PageHeader.astro";
import PostItem from "../../components/PostItem.astro";

const posts = await getCollection("posts");

const allPosts = posts.sort(
  (a, b) =>
    new Date(b.data.datePublished).getTime() -
    new Date(a.data.datePublished).getTime(),
);

const sortByDate = (a: any, b: any) =>
  new Date(b.data.datePublished).getTime() -
  new Date(a.data.datePublished).getTime();

const personal = posts
  .filter((post) => post.data.type === "personal")
  .sort(sortByDate);
const technical = posts
  .filter((post) => post.data.type === "technical")
  .sort(sortByDate);
---

<BaseLayout
  title="Posts"
  description="Essays, thoughts, and technical writing on development, design, and personal reflection."
>
  <CenteredLayout>
    <PageHeader
      title="Posts"
      description="Essays, thoughts, and technical writing on development, design, and personal reflection."
    />

    <div class="filters">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="personal">Personal</button>
      <button class="filter-btn" data-filter="technical">Technical</button>
    </div>

    <div class="posts-container">
      <div id="all-posts" class="posts-section active">
        {
          allPosts.length > 0 ? (
            allPosts.map((post) => <PostItem post={post} />)
          ) : (
            <p class="empty-state">No posts yet.</p>
          )
        }
      </div>

      <div id="personal-posts" class="posts-section">
        {
          personal.length > 0 ? (
            personal.map((post) => <PostItem post={post} />)
          ) : (
            <p class="empty-state">No personal posts yet.</p>
          )
        }
      </div>

      <div id="technical-posts" class="posts-section">
        {
          technical.length > 0 ? (
            technical.map((post) => <PostItem post={post} />)
          ) : (
            <p class="empty-state">No technical posts yet.</p>
          )
        }
      </div>
    </div>
  </CenteredLayout>
</BaseLayout>

<style>
  .filters {
    display: flex;
    gap: var(--space-2xs);
    margin: var(--space-m) 0 var(--space-l);
    flex-wrap: wrap;
  }

  .filter-btn {
    background-color: var(--gray-3);
    border: 1px solid var(--gray-5);
    color: var(--gray-11);
    font-family: "Inter", sans-serif;
    font-size: var(--fs--2);
    font-weight: 500;
    cursor: pointer;
    padding: 3px 10px;
    border-radius: 6px;
    transition:
      background-color var(--duration-fast, 150ms) ease,
      color var(--duration-fast, 150ms) ease,
      border-color var(--duration-fast, 150ms) ease;
  }

  .filter-btn:hover {
    background-color: var(--gray-4);
    color: var(--gray-12);
    border-color: var(--gray-6);
  }

  .filter-btn.active {
    background-color: var(--tomato-9);
    border-color: var(--tomato-9);
    color: white;
  }

  .posts-section {
    display: none;
  }

  .posts-section.active {
    display: block;
    animation: fadeIn 0.25s
      var(--ease-out, cubic-bezier(0.25, 0.46, 0.45, 0.94));
  }

  .empty-state {
    padding: var(--space-xl) 0;
    color: var(--gray-10);
    font-style: italic;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  const FILTER_STORAGE_KEY = "posts-filter";

  function setActiveFilter(filter: string) {
    const filterButtons = document.querySelectorAll(".filter-btn");
    const postsSections = document.querySelectorAll(".posts-section");

    filterButtons.forEach((btn) => {
      btn.classList.toggle(
        "active",
        btn.getAttribute("data-filter") === filter,
      );
    });

    postsSections.forEach((section) => {
      section.classList.remove("active");
    });

    const targetSection = document.getElementById(`${filter}-posts`);
    if (targetSection) {
      targetSection.classList.add("active");
    }

    sessionStorage.setItem(FILTER_STORAGE_KEY, filter);
  }

  function initFilters() {
    const filterButtons = document.querySelectorAll(".filter-btn");

    if (!filterButtons.length) return;

    // Restore saved filter state
    const savedFilter = sessionStorage.getItem(FILTER_STORAGE_KEY);
    const validFilters = ["all", "personal", "technical"];
    if (savedFilter && validFilters.includes(savedFilter)) {
      setActiveFilter(savedFilter);
    }

    filterButtons.forEach((button) => {
      const newButton = button.cloneNode(true) as Element;
      button.parentNode?.replaceChild(newButton, button);

      newButton.addEventListener("click", (e) => {
        const clickedBtn = e.target as Element;
        const filter = clickedBtn.getAttribute("data-filter");
        if (filter) {
          setActiveFilter(filter);
        }
      });
    });
  }

  initFilters();
  document.addEventListener("astro:page-load", initFilters);
</script>
